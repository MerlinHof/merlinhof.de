<html>

<head>
  <meta charset="utf-8"/>
  <title>PID Controller</title>
  <meta name="description" content=""/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/code/pid/">
  <link rel="stylesheet" href="/sources/common.css?v=18">
  <link rel="stylesheet" href="index.css?v=18">
  <script type="text/javascript"></script>
</head>

<body>
  <canvas id="canvas"></canvas>
  <br><t id="statusText"></t>
</body>
</html>


<script>

// Prepare Canvas
let canvas = document.getElementById("canvas");
let height = canvas.clientHeight;
let width = canvas.clientWidth;
let ctx = canvas.getContext("2d");
let pixelFactor = window.devicePixelRatio;
canvas.setAttribute("height", height * pixelFactor);
canvas.setAttribute("width", width * pixelFactor);
ctx.scale(pixelFactor, pixelFactor);


class PIDController {
  constructor() {
    this.state = 0;
    this.targetState = 0;
    this.settings = {
      p: 10,
      i: 0.5,
      d: 30
    }

    this.integral = 0;
    this.prevError = 0;
  }
  update() {
    let error = this.targetState - this.state;
    let p = this.settings.p * error;
    this.integral += error;
    let i = this.settings.i * this.integral;
    let d = this.settings.d * (error-this.prevError);
    this.prevError = error;
    return p+i+d;
  }
}


class Room {
  constructor() {
    this.temperature = 10;
    this.targetTemperature = 20;
    this.tempSpeed = 0;
  }
  controlTemp(val) {
    this.tempSpeed += val;
    this.temperature += 0.01*this.tempSpeed;
  }
}


let room = new Room();
let pid = new PIDController();
let x = 0;
setInterval(() => {
  pid.state = room.temperature;
  pid.targetState = room.targetTemperature;
  let output = pid.update();
  room.controlTemp(output);

  // if (x == 400) {
  //   room.targetTemperature = 10;
  // } else if (x == 600) {
  //   room.targetTemperature = 30;
  // } else if (x == 900) {
  //   room.targetTemperature = 0;
  // }
  if (x%200 == 0) {
    room.targetTemperature = Math.floor(Math.random()*30);
  }

  ctx.fillStyle = "rgb(0, 0, 200)";
  ctx.fillRect(x, 400-10*pid.state, 2, 2);
  ctx.fillStyle = "rgb(200, 0, 0)";
  ctx.fillRect(x, 400-10*pid.targetState, 2, 2);
  x+=2;
});



</script>
