<html>

<head>
  <meta charset="utf-8"/>
  <title>Snake AI</title>
  <meta name="description" content=""/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/code/snakeai/">
  <link rel="stylesheet" href="/sources/common.css?v=18">
  <link rel="stylesheet" href="index.css?v=18">
  <script type="text/javascript"></script>
</head>

<body>
  <canvas id="canvas"></canvas>
  <br><t id="statusText"></t>
</body>
</html>


<script src="nn.js"></script>
<script src="snake.js"></script>
<script>

// Prepare Canvas
let canvas = document.getElementById("canvas");
let height = canvas.clientHeight;
let width = canvas.clientWidth;
let ctx = canvas.getContext("2d");
let pixelFactor = window.devicePixelRatio;
canvas.setAttribute("height", height * pixelFactor);
canvas.setAttribute("width", width * pixelFactor);
ctx.scale(pixelFactor, pixelFactor);

// Setup
let generationSize = 25;
let population = [];
let snake = new Snake(width, height, width/20);

// Update and draw Snake
// setInterval(() => {
//   snake.update();
//   snake.draw(ctx);
// }, 100);


function start() {
  for (let i = 0; i < generationSize; i++) {
    population.push(new Snake(width, height, width/20));
  }
  evaluateGeneration();
}

async function evaluateGeneration() {
  for (let i = 0; i < generationSize; i++) {
    let snake = population[i];
    let cnt = 0;
    while (!snake.dead && cnt < 1000) {
      snake.update();
      cnt++;
    }
    snake.fitness = snake.length + cnt/1000;
  }

  let bestSnake;
  let bestSnakeFitness = -Infinity;
  for (let i = 0; i < generationSize; i++) {
    let snake = population[i];
    if (snake.fitness > bestSnakeFitness) {
      bestSnakeFitness = snake.fitness;
      bestSnake = snake;
    }
  }
  // console.log("Best Snake: " + bestSnakeFitness);
  document.getElementById("statusText").innerHTML = "Best Snake: " + bestSnakeFitness;
  bestSnake.draw(ctx);
  await new Promise(res => setTimeout(res, 100));

  // Create new Population
  for (let i = 0; i < generationSize; i++) {
    let clone = bestSnake.clone();
    clone.brain.mutate(0.03);
    population[i] = clone;
  }
  evaluateGeneration();

}





</script>
